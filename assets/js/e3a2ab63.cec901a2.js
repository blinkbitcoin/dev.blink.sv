"use strict";(self.webpackChunkdev_blink_sv=self.webpackChunkdev_blink_sv||[]).push([[9106],{5818:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var i=t(4848),a=t(8453);const r={id:"oauth2",title:"OAuth2 Integration",slug:"/api/oauth2"},s="OAuth2 Integration Guide",o={id:"api/oauth2",title:"OAuth2 Integration",description:"The OAuth2 integration in Blink empowers third-party applications to authenticate and interact with the Blink backend services seamlessly. By leveraging Ory Hydra, an OAuth 2.0 and OpenID Connect server, applications can obtain secure access to the Blink API, enabling functionalities such as data access and transaction management within the Blink ecosystem.",source:"@site/docs/api/oauth2.md",sourceDirName:"api",slug:"/api/oauth2",permalink:"/api/oauth2",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"oauth2",title:"OAuth2 Integration",slug:"/api/oauth2"},sidebar:"apiSidebar",previous:{title:"Websocket Connection",permalink:"/api/websocket"},next:{title:"Proof of Payment",permalink:"/api/proof-of-payment"}},l={},c=[{value:"Getting Started",id:"getting-started",level:2},{value:"Register Your Application",id:"register-your-application",level:2},{value:"Application Approval",id:"application-approval",level:3},{value:"Scopes",id:"scopes",level:4},{value:"Read",id:"read",level:5},{value:"Receive",id:"receive",level:5},{value:"Write",id:"write",level:5},{value:"Callback URL",id:"callback-url",level:3},{value:"Client ID and Secret",id:"client-id-and-secret",level:3},{value:"OAuth2 Endpoints",id:"oauth2-endpoints",level:3},{value:"Authorization Endpoint",id:"authorization-endpoint",level:4},{value:"Token Endpoint",id:"token-endpoint",level:4},{value:"The OAuth2 Flow",id:"the-oauth2-flow",level:2},{value:"1. Build the Authorization URL",id:"1-build-the-authorization-url",level:3},{value:"Example for staging:",id:"example-for-staging",level:4},{value:"2. Redirect the User",id:"2-redirect-the-user",level:3},{value:"3. Receive the Authorization Code",id:"3-receive-the-authorization-code",level:3},{value:"4. Validate the State Parameter in the Callback",id:"4-validate-the-state-parameter-in-the-callback",level:3},{value:"5. Exchange the Authorization Code for an Access Token",id:"5-exchange-the-authorization-code-for-an-access-token",level:3},{value:"6. Handle the Access Token",id:"6-handle-the-access-token",level:3},{value:"7. Make Authenticated API Requests",id:"7-make-authenticated-api-requests",level:3},{value:"Examples",id:"examples",level:2},{value:"Using the Oauth2-Token Header",id:"using-the-oauth2-token-header",level:3},{value:"Using next-auth in the Blink PoS",id:"using-next-auth-in-the-blink-pos",level:3},{value:"Terraform Configuration Examples",id:"terraform-configuration-examples",level:3},{value:"Blink Dashboard",id:"blink-dashboard",level:4},{value:"Blink PoS",id:"blink-pos",level:4}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"oauth2-integration-guide",children:"OAuth2 Integration Guide"}),"\n",(0,i.jsxs)(n.p,{children:["The OAuth2 integration in Blink empowers third-party applications to authenticate and interact with the Blink backend services seamlessly. By leveraging ",(0,i.jsx)(n.a,{href:"https://github.com/ory/hydra",children:"Ory Hydra"}),", an OAuth 2.0 and OpenID Connect server, applications can obtain secure access to the Blink API, enabling functionalities such as data access and transaction management within the Blink ecosystem."]}),"\n",(0,i.jsx)(n.h2,{id:"getting-started",children:"Getting Started"}),"\n",(0,i.jsxs)(n.p,{children:["Before integrating with Blink OAuth2, it's crucial to have a foundational understanding of ",(0,i.jsx)(n.a,{href:"https://www.ory.sh/docs/oauth2-oidc/overview/oauth2-concepts",children:"OAuth 2.0"})," and ",(0,i.jsx)(n.a,{href:"https://www.ory.sh/docs/oauth2-oidc/overview/oidc-concepts",children:"OpenID Connect (OIDC)"}),". These protocols facilitate secure authorization workflows between your application and Blink services, allowing for authenticated access to user-specific data and actions.",(0,i.jsx)("br",{}),"\nThe connecting applications are using the ",(0,i.jsx)(n.a,{href:"https://www.ory.sh/docs/oauth2-oidc/authorization-code-flow",children:"OAuth2 authorization code flow"}),".",(0,i.jsx)("br",{}),"\nFor a hands-on introduction to setting up OAuth2 with Ory Hydra, you can explore this ",(0,i.jsx)(n.a,{href:"https://www.ory.sh/docs/hydra/5min-tutorial",children:"5-minute tutorial"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"register-your-application",children:"Register Your Application"}),"\n",(0,i.jsx)(n.p,{children:"To initiate the integration process, your application must be registered and approved by Blink's development team. This is a critical step to ensure secure and authorized access to Blink's API functionalities."}),"\n",(0,i.jsx)(n.h3,{id:"application-approval",children:"Application Approval"}),"\n",(0,i.jsxs)(n.p,{children:["Reach out to the Blink development team via our Mattermost server at ",(0,i.jsx)(n.a,{href:"https://chat.blink.sv",children:"chat.blink.sv"})," to start the approval process for using OAuth2. You'll need to provide details about your application, including its purpose, the scopes of access required and your callback URL where the authorization code will be delivered."]}),"\n",(0,i.jsx)(n.h4,{id:"scopes",children:"Scopes"}),"\n",(0,i.jsx)(n.h5,{id:"read",children:"Read"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Allows queries returning user info, wallet balance, transaction history and other features."}),"\n"]}),"\n",(0,i.jsx)(n.h5,{id:"receive",children:"Receive"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Allows to create invoices and generate onchain addresses."}),"\n",(0,i.jsx)(n.li,{children:"Note that there are methods to create invoices without authentication with a stricter rate limiting applied."}),"\n"]}),"\n",(0,i.jsx)(n.h5,{id:"write",children:"Write"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Allows to send payments and modify user data."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"callback-url",children:"Callback URL"}),"\n",(0,i.jsx)(n.p,{children:"After a user grants or denies access to your application, the Blink OAuth2 server will redirect the user back to your application using the callback (aka redirect) URL. This URL is where the Blink OAuth2 server sends the authorization code as a query parameter."}),"\n",(0,i.jsx)(n.h3,{id:"client-id-and-secret",children:"Client ID and Secret"}),"\n",(0,i.jsx)(n.p,{children:"After the registration with Blink you will receive a client ID and a client secret from us. These are unique identifiers that allow the Blink OAuth2 server to identify your application and allow it to access protected resources. The client ID is considered public information and can be included in JavaScript source code or used to build login URLs. The client secret, however, must be kept confidential and is used to authenticate the client to the authorization server."}),"\n",(0,i.jsx)(n.h3,{id:"oauth2-endpoints",children:"OAuth2 Endpoints"}),"\n",(0,i.jsx)(n.h4,{id:"authorization-endpoint",children:"Authorization Endpoint"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Blink","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"https://oauth.blink.sv/oauth2/auth\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Staging","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"https://oauth.staging.blink.sv/oauth2/auth\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"token-endpoint",children:"Token Endpoint"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Blink","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"https://oauth.blink.sv/oauth2/token\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Staging","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"https://oauth.staging.blink.sv/oauth2/token\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"the-oauth2-flow",children:"The OAuth2 Flow"}),"\n",(0,i.jsx)(n.h3,{id:"1-build-the-authorization-url",children:"1. Build the Authorization URL"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Construct a URL to redirect the user to the provider's authorization endpoint."}),"\n",(0,i.jsx)(n.li,{children:'Include the client ID, callback URI, response type (usually "code"), scopes (permissions you\'re requesting) and a minimum character long state parameter.'}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"example-for-staging",children:"Example for staging:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["use a valid ",(0,i.jsx)(n.code,{children:"client_id"})," which was registered with the OAuth2 server"]}),"\n",(0,i.jsxs)(n.li,{children:["your redirect url (",(0,i.jsx)(n.code,{children:"yourapp.com/callback"})," in the example)"]}),"\n",(0,i.jsxs)(n.li,{children:["the ",(0,i.jsx)(n.code,{children:"state"})," parameter serves to identify the request","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"https://oauth.staging.blink.sv/oauth2/auth?response_type=code&client_id=<client_id>&redirect_uri=https%3A%2F%2Fyourapp.com%2Fcallback&scope=read+receive+write&state=<request_identifier>\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"2-redirect-the-user",children:"2. Redirect the User"}),"\n",(0,i.jsx)(n.p,{children:"Open the constructed URL to log in with OAuth2.\nThe user will log in to Blink and approve the requested permissions.\nThe Blink Oauth2 server will redirect the user to your callback URL with an authorization code in the query parameters."}),"\n",(0,i.jsx)(n.h3,{id:"3-receive-the-authorization-code",children:"3. Receive the Authorization Code"}),"\n",(0,i.jsx)(n.p,{children:"Your application should handle the callback request.\nExtract the code parameter from the query string."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"https://yourapp.com/callback?code=ory_ac_AUTHORIZATION_CODE&scope=read+receive+write&state=<request_identifier>\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-validate-the-state-parameter-in-the-callback",children:"4. Validate the State Parameter in the Callback"}),"\n",(0,i.jsx)(n.p,{children:"Ensure that the state parameter returned in the callback matches the one which was sent in the Authorization URL."}),"\n",(0,i.jsx)(n.h3,{id:"5-exchange-the-authorization-code-for-an-access-token",children:"5. Exchange the Authorization Code for an Access Token"}),"\n",(0,i.jsx)(n.p,{children:"Make a POST request to the token endpoint with the authorization code, client ID, client secret, and redirect URI."}),"\n",(0,i.jsx)(n.p,{children:"Example using curl:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'# set the variables\nAUTHORIZATION_CODE=<ory_ac_...>\nYOUR_CALLBACK_URL=<https://yourapp.com/callback>\nYOUR_CLIENT_ID=<client_id>\nYOUR_CLIENT_SECRET=<client_secret>\n\ncurl -X POST \\\n  -u "$YOUR_CLIENT_ID:$YOUR_CLIENT_SECRET" \\\n  -d "grant_type=authorization_code" \\\n  -d "code=$AUTHORIZATION_CODE" \\\n  -d "redirect_uri=$YOUR_CALLBACK_URL" \\\nhttps://oauth.blink.sv/oauth2/token\n'})}),"\n",(0,i.jsx)(n.h3,{id:"6-handle-the-access-token",children:"6. Handle the Access Token"}),"\n",(0,i.jsx)(n.p,{children:"The response will include an access token.\nStore and use the access token to authenticate API requests.\nExample response:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'{\n  "access_token": "ory_at_...",\n  "expires_in": 3599,\n  "scope": "read receive write",\n  "token_type": "bearer"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"7-make-authenticated-api-requests",children:"7. Make Authenticated API Requests"}),"\n",(0,i.jsx)(n.p,{children:"Use the access token in the Authorization header of your API requests.\nExample using curl:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"ACCESS_TOKEN=<ory_at_...>\n\ncurl -sS --request POST --header 'content-type: application/json' \\\n  --header 'Oauth2-Token: $ACCESS_TOKEN' \\\n  --url 'https://api.blink.sv/graphql' \\\n  --data '{\"query\":\"query me { me { defaultAccount { wallets { id walletCurrency }}}}\", \"variables\":{}}'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,i.jsx)(n.h3,{id:"using-the-oauth2-token-header",children:"Using the Oauth2-Token Header"}),"\n",(0,i.jsxs)(n.p,{children:["Note that the Oauth2 token needs a different header for Authentication (compared to API keys using the ",(0,i.jsx)(n.code,{children:"X-API-KEY"})," header or the authentication token used in the Blink mobile app):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'"Oauth2-Token" "ory_at_..."\n'})}),"\n",(0,i.jsx)(n.p,{children:"Example header for the Blink PoS:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'      headers: {\n        ...(options?.token ? { ["Oauth2-Token"]: options.token } : {}),\n      },\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Link to the ",(0,i.jsx)(n.a,{href:"https://github.com/GaloyMoney/blink/pull/4149/files#diff-d5101fe657d3e5befe3ec31871012666597b3f346292241dffde4938c625090dR21",children:"code with the context"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"using-next-auth-in-the-blink-pos",children:["Using ",(0,i.jsx)(n.a,{href:"https://www.npmjs.com/package/next-auth",children:"next-auth"})," in the Blink PoS"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'export const authOptions: NextAuthOptions = {\n  providers: [\n    {\n      id: "blink",\n      clientId: env.CLIENT_ID,\n      clientSecret: env.CLIENT_SECRET,\n      wellKnown: `${env.HYDRA_PUBLIC}/.well-known/openid-configuration`,\n      authorization: {\n        params: { scope: "read" },\n      },\n      idToken: false,\n      name: "Blink",\n      type,\n      profile(profile) {\n        return {\n          id: profile.sub,\n        }\n      },\n    },\n  ],\n  debug: process.env.NODE_ENV === "development",\n  secret: env.NEXTAUTH_SECRET,\n  callbacks: {\n    async jwt({ token, account, profile }) {\n      if (account) {\n        token.accessToken = account.access_token\n        token.expiresAt = account.expires_at\n        token.refreshToken = account.refresh_token\n        token.id = profile?.id\n      }\n      return token\n    },\n    async session({ session, token }) {\n      if (\n        !token.accessToken ||\n        !token.sub ||\n        typeof token.accessToken !== "string" ||\n        typeof token.sub !== "string"\n      ) {\n        throw new Error("Invalid token")\n      }\n      const res = await fetchUserData({ token: token.accessToken })\n\n      if (!(res instanceof Error)) {\n        session.userData = res.data\n      }\n      session.sub = token.sub\n      session.accessToken = token.accessToken\n      return session\n    },\n  },\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Link to the ",(0,i.jsx)(n.a,{href:"https://github.com/GaloyMoney/blink/pull/4149/files#diff-224eae5be0d335d0d64941907106c189977dc51b2a0139459083b777efddf953R19-R70",children:"code with the context"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"terraform-configuration-examples",children:"Terraform Configuration Examples"}),"\n",(0,i.jsxs)(n.p,{children:["Below are the Terraform configurations for two existing Blink integrations, showcasing how to set up OAuth2 clients for different applications using the ",(0,i.jsx)(n.a,{href:"https://registry.terraform.io/providers/svrakitin/hydra/latest/docs/resources/oauth2_client",children:"hydra_oauth2_client Terraform resource"})," :"]}),"\n",(0,i.jsx)(n.h4,{id:"blink-dashboard",children:"Blink Dashboard"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["try it at ",(0,i.jsx)(n.a,{href:"https://dashboard.blink.sv",children:"dashboard.blink.sv"})]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'resource "hydra_oauth2_client" "api_dashboard" {\n  client_name                = "Blink Api Dashboard"\n  grant_types                = ["authorization_code"]\n  response_types             = ["code", "id_token"]\n  token_endpoint_auth_method = "client_secret_basic"\n  scopes                     = ["read", "write"]\n  redirect_uris              = [local.api_dashboard_hydra_redirect_uri]\n  skip_consent               = true\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"blink-pos",children:"Blink PoS"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["try it at ",(0,i.jsx)(n.a,{href:"https://pay.blink.sv",children:"pay.blink.sv"})]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'resource "hydra_oauth2_client" "galoy_pay" {\n  client_name                = "Blink POS"\n  grant_types                = ["authorization_code"]\n  response_types             = ["code", "id_token"]\n  token_endpoint_auth_method = "client_secret_basic"\n  scopes                     = ["read"]\n  redirect_uris              = [for host in local.galoy_pay_hosts : "https://${host}/api/auth/callback/blink"]\n  skip_consent               = true\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["If you encounter any challenges or have questions during the integration process, don't hesitate to reach out to the Blink development team for assistance at our Mattermost server at ",(0,i.jsx)(n.a,{href:"https://chat.blink.sv",children:"chat.blink.sv"}),"."]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var i=t(6540);const a={},r=i.createContext(a);function s(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);